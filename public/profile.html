<!DOCTYPE html>
<html>
<head>
  <title>Profile</title>
</head>
<body>
  <h1>Player Profile</h1>
  <div id="profileArea">Loading...</div>
  <button id="backBtn">Back to Lobby</button>
  <script>
    document.getElementById('backBtn').addEventListener('click', () => { window.location.href = '/'; });

    async function loadProfile() {
      const res = await fetch('/api/session', { credentials: 'same-origin' });
      const data = await res.json();
      const area = document.getElementById('profileArea');
      area.innerHTML = '';
      if (!data.loggedIn) {
        area.textContent = 'Not logged in';
        return;
      }

      const user = data.user;
      const meDiv = document.createElement('div');
      meDiv.innerHTML = `<strong>Username:</strong> ${user.username} <br><strong>ID:</strong> ${user.userId}`;
      area.appendChild(meDiv);

      // Password reset form for self
      const resetForm = document.createElement('div');
      resetForm.innerHTML = `
        <h3>Reset Your Password</h3>
        <input id="newPass" type="password" placeholder="New password" />
        <input id="newPassConfirm" type="password" placeholder="Confirm new password" />
        <button id="resetBtn">Reset Password</button>
        <div id="resetMsg"></div>
      `;
      area.appendChild(resetForm);

      document.getElementById('resetBtn').addEventListener('click', async () => {
        const np = document.getElementById('newPass').value;
        const nc = document.getElementById('newPassConfirm').value;
        const msg = document.getElementById('resetMsg');
        msg.textContent = '';
        if (!np || !nc) return msg.textContent = 'Fill both fields';
        if (np !== nc) return msg.textContent = 'Passwords do not match';

        const r = await fetch('/api/auth/resetPassword', {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user.username, newPassword: np })
        });
        const d = await r.json();
        msg.textContent = d.success ? 'Password reset successful' : (d.message || 'Reset failed');
      });

      // If admin, show user list with bypass toggles
      const adminSection = document.createElement('div');
      adminSection.id = 'adminSection';
      area.appendChild(adminSection);

      // check if admin
      const check = await fetch(`/api/session`, { credentials: 'same-origin' });
      const s = await check.json();
      // request server to know if caller is admin by fetching users via a new endpoint or reuse myPlayer? We'll call a server endpoint
      const whoami = await fetch('/api/myPlayer', { credentials: 'same-origin' }).catch(() => null);
      // Simpler: ask server for user record
      const rr = await fetch('/api/_whoami', { credentials: 'same-origin' }).catch(() => null);
      if (rr && rr.ok) {
        const rrj = await rr.json();
        if (rrj.is_admin) {
          adminSection.innerHTML = '<h3>Admin: Manage Users</h3><div id="usersList">Loading users...</div>';
          const ul = document.getElementById('usersList');
          const usersRes = await fetch('/api/_listUsers', { credentials: 'same-origin' });
          if (usersRes.ok) {
            const users = await usersRes.json();
            ul.innerHTML = '';
            users.forEach(u => {
              const row = document.createElement('div');
              row.innerHTML = `<span>${u.username} (${u.id})</span>`;
              const cb = document.createElement('input');
              cb.type = 'checkbox';
              cb.checked = !!u.reset_bypass;
              cb.addEventListener('change', async () => {
                await fetch('/api/admin/setResetBypass', {
                  method: 'POST', credentials: 'same-origin', headers: {'Content-Type':'application/json'},
                  body: JSON.stringify({ username: u.username, bypass: cb.checked })
                });
              });
              row.appendChild(cb);
              ul.appendChild(row);
            });
          } else {
            ul.textContent = 'Failed to load users';
          }
        }
      }
    }

    loadProfile();
  </script>
</body>
</html>